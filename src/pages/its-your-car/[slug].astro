---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import IYCEmployees from '../../components/iyc/IYCEmployees.astro';
import IYCLocation from '../../components/iyc/IYCLocation.astro';

export const prerender = true; // Enable static generation for first 500 posts

// ✅ Generate static pages for the first 500 most recent posts
export async function getStaticPaths() {
  const { data: posts, error } = await supabase
    .from('iyc_with_relations')
    .select('slug')
    .eq('published', true)
    .order('created_at', { ascending: false }) // Newest first
    .limit(500); // Static render for first 500

  if (error || !posts) {
    console.error('Error fetching slugs:', error);
    return [];
  }

  return posts.map(post => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

// Fetch post data
const { data: post, error: postError } = await supabase
  .from('iyc_with_relations')
  .select('*')
  .eq('slug', slug)
  .eq('published', true)
  .single();

if (postError || !post) {
  console.error(`Post not found: ${slug}`, postError);
  return Astro.redirect('/404');
}

// Handle employees data safely
let employeeIds = [];
try {
  if (post.employees && typeof post.employees === 'string') {
    const parsed = JSON.parse(post.employees);
    employeeIds = Array.isArray(parsed) ? parsed.map(emp => emp.id) : [];
  } else if (Array.isArray(post.employees)) {
    employeeIds = post.employees.map(emp => emp.id);
  }
} catch (err) {
  console.error('Error parsing employees:', err);
}

// Format publish date
const publishDate = new Date(post.published_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<Layout 
  title={post.title}
  description={post.excerpt}
  image={post.featured_image_url}
>
  <article class="min-h-screen bg-gray-50">
    <!-- Hero Section -->
    <div class="relative">
      <div class="absolute inset-0">
        <img 
          src={post.quirk_location_featured_image || 'https://images.unsplash.com/photo-1486006920555-c77dcf18193c?auto=format&fit=crop&q=80'}
          alt={post.quirk_location_title}
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-gradient-to-r from-primary/90 to-primary/70"></div>
      </div>
      <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
        <div class="flex flex-col sm:flex-row items-start gap-8">
          {post.quirk_location_logo && (
            <div class="flex-shrink-0">
              <img 
                src={post.quirk_location_logo}
                alt={`${post.quirk_location_title} logo`}
                class="h-24 sm:h-32 bg-white rounded-lg p-2"
              />
            </div>
          )}
          <div>
            <div class="flex flex-wrap gap-3 mb-6">
              {post.quirk_location_title && (
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 text-white">
                  {post.quirk_location_title}
                </span>
              )}
              {post.location_name && (
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-secondary/80 text-white">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {post.location_name}
                </span>
              )}
              <time class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 text-white">
                {publishDate}
              </time>
            </div>

            <h1 class="text-4xl font-extrabold tracking-tight text-white sm:text-5xl lg:text-6xl mb-6">
              {post.title}
            </h1>

            {post.content && (
              <div class="text-white prose prose-invert">
                <div set:html={post.content} />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <div class="w-full h-[600px] bg-gray-100 rounded-lg shadow-lg overflow-hidden">
          {post.featured_image_url && (
            <img 
              src={post.featured_image_url}
              alt={post.title}
              class="w-full h-full object-contain"
              loading="lazy"
            />
          )}
        </div>

        <div class="space-y-8">
          {post.quirk_location_id && <IYCLocation locationId={post.quirk_location_id} />}
          {employeeIds.length > 0 && <IYCEmployees employeeIds={employeeIds} />}
        </div>
      </div>
      
      <!-- Divider -->
      <hr class="my-12 border-gray-200" />

      <!-- ✅ Enhanced Content Section Restored -->
      {post.enhanced_content && (
        <div class="prose prose-lg max-w-none mx-auto bg-white rounded-lg shadow-lg p-8">
          <div set:html={post.enhanced_content} />
        </div>
      )}
    </div>
  </article>
</Layout>
